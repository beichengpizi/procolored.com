{% comment %}
  Renders facets (filtering and sorting)
  Accepts:
  - results: {Object} Collection or Search object
  - enable_filtering: {Boolean} Show filtering when true
  - enable_sorting: {Boolean} Show sorting when true
  - collapse_on_larger_devices: {Boolean} Collapse filtering/sorting into menu on larger devices when true
  Usage:
  {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, collapse_on_larger_devices: false %}
{% endcomment %}

{%- liquid
  assign sort_by = results.sort_by | default: results.default_sort_by
  if results.url
    assign results_url = results.url
  else
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}

<style>
  .facets .col-list {
    border-bottom: 1px solid var(--color-border, #dadce0);
  }
  .facets .col-list-menu-mb {
    padding-bottom: 22px;
  }
  .facets .col-list .col-item {
    display: flex;
    align-items: center;
  }
  .facets .col-list .col-item input {
    margin-right: 7px;
    width: 14px;
    height: 14px;
  }
  .facets .col-list .col-item .col-link {
    margin-top: 3px;
    font-size: 0.9375rem;
    font-weight: 400;
    letter-spacing: 0.02em;
    color: var(--color-body, #2c2d2e);
  }
  .facets .col-list-title-mb.open span {
    transform: rotateX(180deg);
  }
</style>

{%- if enable_filtering -%}
  <div class="side-panel facet-drawer" id="Facet-Drawer">
    <div class="side-panel-inner">
      <div class="side-panel-header">
        <div>
          <span class="h6">
            {{- 'products.facets.filter_button' | t }}
            <span class="thb-filter-count mobile-filter-count body-font">
              <span class="facets__label">
                {%- if results.results_count -%}
                  {{ 'search.results_with_count' | t: terms: results.terms, count: results.results_count }}
                {%- elsif results.products_count == results.all_products_count -%}
                  {{ 'products.facets.product_count_simple' | t: count: results.products_count }}
                {%- else -%}
                  {{
                    'products.facets.product_count'
                    | t: product_count: results.products_count, count: results.all_products_count
                  }}
                {%- endif -%}
              </span>
              <span class="loading-overlay">
                {% render 'svg-icons' with 'thb-loading' %}
              </span>
            </span>
          </span>
          <side-panel-close class="side-panel-close">{%- render 'svg-icons' with 'close' -%}</side-panel-close>
        </div>
      </div>
      <div class="side-panel-content">
        <facet-filters-form class="facets">
          <div class="col-list">
            <div class="col-list-title-mb">
              Collection
              <span>
                <svg width="14" height="8" viewBox="0 0 14 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M13 6.81818L7 0.818176L1 6.81818" stroke="var(--color-heading)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </span>
            </div>
            <div class="col-list-menu-mb">
              {% for link in linklists['collection-list'].links -%}
                <div class="col-item">
                  <input
                    type="checkbox"
                    name="{{ link.title }}"
                    value="{{ link.url }}"
                  >
                  <div class="col-link">
                    <a href="{{ link.url }}">{{ link.title }}</a>
                  </div>
                </div>
              {%- endfor %}
            </div>
          </div>
          <form id="FacetFiltersFormMobile" class="facets__mobile_form" data-search-type="{{search_type}}">
            {%- if results.terms -%}
              <input type="hidden" name="q" value="{{ results.terms | escape }}">
              <input name="options[prefix]" type="hidden" value="last">
            {%- endif -%}
            {% if results.current_vendor or results.current_type %}
              <input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
            {% endif %}
            {%- for filter in results.filters -%}
              {% case filter.type %}
                {% when 'boolean', 'list' %}
                  {%- liquid
                    assign label = filter.label | downcase | replace: ' ', '-' | escape
                    assign slug = filter.label | downcase | escape
                  -%}
                  {%- assign hide_options = collection.metafields.custom.collection_page_hide_filter_options.value
                    | join: ','
                    | strip
                  -%}
                  {%- unless hide_options contains label -%}
                    <collapsible-row data-index="{{ forloop.index }}">
                      <details class="thb-filter js-filter" open>
                        <summary class="thb-filter-title">
                          {{ filter.label | escape -}}
                          <span>{%- render 'svg-icons' with 'thb-collapsible-arrow' -%}</span>
                        </summary>
                        <div class="thb-filter-content collapsible__content">
                          {%- if filter.param_name == 'filter.v.availability' -%}
                            <div class="thb-filter-availability">
                              {%- assign value = filter.values[0] -%}
                              <input
                                type="checkbox"
                                name="{{ value.param_name }}"
                                value="{{ value.value }}"
                                class="thb-filter-switch custom-checkbox"
                                id="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                {% if value.active %}
                                  checked
                                {% endif %}
                                {% if value.count == 0 and value.active == false %}
                                  disabled
                                {% endif %}
                              >
                              <label for="Filter-Mobile-{{ label }}-{{ forloop.index }}">{{ value.label }}</label>
                            </div>
                          {%- else -%}
                            <scroll-shadow>
                              {%- liquid
                                if slug contains 'color' or slug contains 'colour' or slug contains 'couleur' or slug contains 'farbe'
                                  if filter_color_swatches
                                    assign slug = 'color'
                                  else
                                    assign slug = ''
                                  endif
                                endif

                                if filter.presentation == 'swatch'
                                  assign slug = 'color'
                                endif
                              -%}
                              <ul class="{{ filter.type | escape }}-{{ slug }}">
                                {%- liquid
                                  assign custom_colors = settings.color_swatches | newline_to_br | split: '<br />'
                                  assign key_array = ''
                                  assign val_array = ''

                                  for color in custom_colors
                                    assign key = color | split: ':' | first | rstrip
                                    assign value = color | split: ':' | last | lstrip
                                    assign key_array = key_array | append: ',' | append: key
                                    assign val_array = val_array | append: ',' | append: value
                                  endfor

                                  assign key_array = key_array | remove_first: ',' | strip_newlines | downcase | split: ','
                                  assign val_array = val_array | remove_first: ',' | split: ','

                                  assign sorted_values = filter.values
                                  # Keep the selected values grouped together when operator is AND
                                  if filter.operator == 'AND'
                                    assign active_filter_values = filter.values | where: 'active', true
                                    assign inactive_filter_values = filter.values | where: 'active', false
                                    assign sorted_values = active_filter_values | concat: inactive_filter_values
                                  endif
                                -%}
                                {%- for value in sorted_values -%}
                                  <li>
                                    <input
                                      type="checkbox"
                                      name="{{ value.param_name }}"
                                      value="{{ value.value }}"
                                      id="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                      {% if value.active %}
                                        checked
                                      {% endif %}
                                      {% if value.count == 0 and value.active == false %}
                                        disabled
                                      {% endif %}
                                    >
                                    {%- if filter.presentation == 'swatch' -%}
                                      {%- liquid
                                        if value.display.type == 'colors'
                                          assign bg_value = empty
                                          assign size_limit = value.display.value.size | at_most: 4
                                          assign rotation = '0deg'
                                          if size_limit == 2
                                            assign rotation = '45deg'
                                          endif

                                          assign angle_increment = 360 | divided_by: size_limit
                                          assign angle = 0
                                        endif
                                        if value.display.type == 'image'
                                          assign bg_value = value.display.value | image_url: width: 40, height: 40
                                        endif
                                      -%}
                                      {%- capture conic_gradient -%}
																	{%- for color in value.display.value limit: size_limit -%}
																		{{ color }} {{ angle }}deg{%- assign angle = angle | plus: angle_increment %} {{ angle }}deg{%- unless forloop.last %}, {%- endunless -%}
																	{%- endfor -%}
																{%- endcapture -%}
                                      <label
                                        for="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                        class="facet-checkbox facet-checkbox--presentation{% if value.count == 0 and value.active == false %} facet-checkbox--disabled{% endif %}"
                                        style="--option-color-image:{%- if bg_value == empty -%}conic-gradient({{ conic_gradient }}){%- else -%}url('{{ bg_value }}'){%- endif -%};"
                                        data-tooltip="{{ value.label | escape }} ({{ value.count }})"
                                      >
                                        <span class="filter-color"></span>
                                        <span class="filter-name">{{ value.label | escape }}</span>
                                        {% if show_counts -%}
                                          <sup class="count">{{ value.count }}</sup>
                                        {%- endif -%}
                                      </label>
                                    {%- else -%}
                                      {%- liquid
                                        assign color_value = value.value | downcase | escape

                                        for custom_color in key_array
                                          if custom_color == color_value
                                            assign color_value = val_array[forloop.index0]
                                          endif
                                        endfor

                                        assign bg_value = false
                                        if color_value contains '.'
                                          assign bg_value = color_value | file_url
                                          assign color_value = 'var(--bg-body)'
                                        endif
                                      -%}
                                      <label
                                        for="Filter-Mobile-{{ label }}-{{ forloop.index }}"
                                        class="facet-checkbox{% if value.count == 0 and value.active == false %} facet-checkbox--disabled{% endif %}"
                                        style="--bg-color: {{ color_value | downcase | escape }};{%- if bg_value -%} --option-color-image: url('{{ bg_value | escape }}');{%- endif -%}"
                                        data-tooltip="{{ value.label | escape }} ({{ value.count }})"
                                      >
                                        <span class="filter-color"></span>
                                        <span class="filter-name">{{- value.label | escape }}</span>
                                        {% if show_counts -%}
                                          <span class="count">({{ value.count }})</span>
                                        {%- endif %}
                                      </label>
                                    {%- endif -%}
                                  </li>
                                {%- endfor -%}
                              </ul>
                            </scroll-shadow>
                          {%- endif -%}
                        </div>
                      </details>
                    </collapsible-row>
                  {%- endunless -%}
                {% when 'price_range' %}
                  <collapsible-row data-index="{{ forloop.index }}">
                    <details class="thb-filter js-filter" data-index="{{ forloop.index }}" open>
                      <summary class="thb-filter-title">
                        {{ filter.label | escape -}}
                        <span>{%- render 'svg-icons' with 'thb-collapsible-arrow' -%}</span>
                      </summary>
                      <div class="thb-filter-content collapsible__content">
                        <div class="{{ filter.type | escape }} {{ filter.type | escape }}-{{ filter.label | downcase | escape }}">
                          {%- liquid
                            assign currencies_using_comma_decimals = 'ANG,ARS,BRL,BYN,BYR,CLF,CLP,COP,CRC,CZK,DKK,EUR,HRK,HUF,IDR,ISK,MZN,NOK,PLN,RON,RUB,SEK,TRY,UYU,VES,VND' | split: ','
                            assign uses_comma_decimals = false
                            if currencies_using_comma_decimals contains cart.currency.iso_code
                              assign uses_comma_decimals = true
                            endif

                            assign max_value = null
                            assign min_value = null
                            if uses_comma_decimals
                              if filter.max_value.value
                                assign max_value = filter.max_value.value | money_without_currency | replace: '.', ''
                              endif
                              if filter.min_value.value
                                assign min_value = filter.min_value.value | money_without_currency | replace: '.', ''
                              endif
                              assign range_max = filter.range_max | money_without_currency | replace: '.', ''
                            else
                              if filter.max_value.value
                                assign max_value = filter.max_value.value | money_without_currency | replace: ',', ''
                              endif
                              if filter.min_value.value
                                assign min_value = filter.min_value.value | money_without_currency | replace: ',', ''
                              endif
                              assign range_max = filter.range_max | money_without_currency | strip_html | replace: ',', '' | divided_by: 1.00
                            endif
                          -%}
                          {%- assign max_price_amount = filter.range_max | money | strip_html | escape -%}
                          <span class="price-highest">
                            {{- 'products.facets.max_price' | t: price: max_price_amount -}}
                          </span>
                          <price-slider class="price_slider_wrapper">
                            <div
                              class="price_slider"
                              data-min-value="{{ min_value }}"
                              data-min-name="filter.v.price.gte"
                              data-min="0"
                              data-max-value="{{ max_value }}"
                              data-max-name="filter.v.price.lte"
                              data-max="{{ range_max }}"
                            ></div>
                            <div class="price_slider_amount">
                              <div class="price_slider_amount__single">
                                <span class="field-currency">{{ cart.currency.symbol }}</span>
                                <input
                                  class="field__input field__input_min"
                                  name="{{ filter.min_value.param_name }}"
                                  id="Filter-{{ filter.label | escape }}-GTE-mobile"
                                  value="{{ min_value }}"
                                  type="text"
                                  placeholder="0"
                                >
                              </div>
                              <span>—</span>
                              <div class="price_slider_amount__single">
                                <span class="field-currency">{{ cart.currency.symbol }}</span>
                                <input
                                  class="field__input field__input_max"
                                  name="{{ filter.max_value.param_name }}"
                                  id="Filter-{{ filter.label | escape }}-LTE-mobile"
                                  value="{{ max_value }}"
                                  type="text"
                                  placeholder="{{ filter.range_max | money_without_currency }}"
                                >
                              </div>
                            </div>
                          </price-slider>
                        </div>
                      </div>
                    </details>
                  </collapsible-row>
              {%- endcase -%}
            {%- endfor -%}
            {% comment %}
              {%- if enable_sorting -%}
                <div class="thb-filter-sort-count thb-filter">
                  <div class="thb-filter-sort">
                    <div class="thb-filter-title">{{ 'products.facets.sort_by_label' | t }}</div>
                    <div class="select">
                      {%- assign sort_by = results.sort_by | default: results.default_sort_by -%}
                      <select
                        name="sort_by"
                        class="facet-filters__sort select__select caption-large"
                        id="SortByMobile"
                        aria-describedby="a11y-refresh-page-message"
                      >
                        {%- for option in results.sort_options -%}
                          <option
                            value="{{ option.value | escape }}"
                            {% if option.value == sort_by %}
                              selected="selected"
                            {% endif %}
                          >
                            {{ option.name | escape }}
                          </option>
                        {%- endfor -%}
                      </select>
                      <div class="select-arrow">{%- render 'svg-icons' with 'thb-collapsible-arrow' -%}</div>
                    </div>
                  </div>
                </div>
              {%- endif -%}
            {% endcomment %}
          </form>
        </facet-filters-form>
      </div>
      <div class="side-panel-footer">
        <div class="side-panel-footer-clear-inner">
          <a class="mobile-filters-clear text-button" href="{{ results_url }}">{{ 'products.facets.clear' | t }}</a>
        </div>
        <button class="button mobile-filters-apply" onclick="document.querySelector('.click-capture').click()">
          <span>{{ 'products.facets.apply' | t }}</span>
        </button>
      </div>
    </div>
  </div>
{%- endif -%}

<script>
  $(document).ready(function () {
    // 页面加载时判断并勾选
    $(".col-list-menu-mb input[type='checkbox']").each(function () {
      if (window.location.href.indexOf($(this).val()) > -1) {
        $(this).prop('checked', true);
      }
    });

    // 勾选checkbox或点击a标签时处理
    $(".col-list-menu-mb input[type='checkbox'],.col-list-menu-mb a").click(function () {
      var checkbox = $(this).is("input[type='checkbox']") ? $(this) : $(this).parent().prev("input[type='checkbox']");
      if (window.location.href.indexOf(checkbox.val()) === -1) {
        $("input[type='checkbox']").prop('checked', false);
        checkbox.prop('checked', true);
        window.location.href = checkbox.val();
      } else {
        checkbox.prop('checked', true);
        if ($(this).is('a')) {
          event.preventDefault();
        }
      }
    });
    $('.col-list-title-mb').click(function () {
      $(this).toggleClass('open').siblings('.col-list-menu-mb').slideToggle();
    });
  });
</script>

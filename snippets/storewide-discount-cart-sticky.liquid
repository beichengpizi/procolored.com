<style>
  .cart-drawer-storewide-discount-cart-sticky-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    background: #fff4e2;
  }

  .cart-drawer-storewide-discount-cart-sticky-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .cart-drawer-storewide-discount-cart-sticky-info-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .cart-drawer-storewide-discount-cart-sticky-info-text,
  .cart-drawer-storewide-discount-cart-sticky-max-discount-text {
    color: #a4712c;
    font-size: 14px;
    font-weight: 400;
    line-height: 1.4;
  }

  .cart-drawer-storewide-discount-cart-sticky-current-discount {
    color: #a4712c;
    font-size: 14px;
    font-weight: 700;
    line-height: 1.33;
  }

  /* è¿›åº¦æ¡å®¹å™¨ */
  .cart-drawer-storewide-discount-cart-sticky-progress-bar {
    --p: 100%;
    position: relative;
    width: 100%;
    height: 12px;
    border-radius: 99px;
    margin-top: 14px;
  }

  /* è½¨é“ï¼šå·¦æ¸å˜ï¼Œå³ç™½è‰² */
  .cart-drawer-storewide-discount-cart-sticky-progress-track {
    width: 100%;
    height: 100%;
    border-radius: inherit;
    /* background: linear-gradient(90deg, #ff2ace 0%, #FF8F1C 100%) 0 0 / var(--p) 100% no-repeat, #ffffff;  */
    background: linear-gradient(90deg, #ff8f1c 0%, #ff8f1c 100%) 0 0 / var(--p) 100% no-repeat, #ffffff;
  }
  .cart-drawer-storewide-discount-cart-sticky-max-discount-text {
    width: 0;
    height: 0;
    visibility: hidden;
  }
  @media screen and (max-width: 768px) {
    .cart-drawer-storewide-discount-cart-sticky-wrapper {
    }

    .cart-drawer-storewide-discount-cart-sticky-info {
      display: flex;
      align-items: center;
      gap: 5px;
      width: 100%;
      padding-left: 24px;
    }

    .cart-drawer-storewide-discount-cart-sticky-info-icon {
      width: 14px;
      height: 20px;
    }

    .cart-drawer-storewide-discount-cart-sticky-info-text,
    .cart-drawer-storewide-discount-cart-sticky-max-discount-text {
      font-size: 12px;
      line-height: 1.25;
    }

    .cart-drawer-storewide-discount-cart-sticky-current-discount {
      font-size: 14px;
      line-height: 1.25;
    }

    /* è¿›åº¦æ¡å®¹å™¨ */
    .cart-drawer-storewide-discount-cart-sticky-progress-bar {
      height: 6px;
      margin-top: 7px;
    }
  }
</style>
<div class="cart-drawer-storewide-discount-cart-sticky-wrapper">
  <div class="cart-drawer-storewide-discount-cart-sticky-info">
    <div class="cart-drawer-storewide-discount-cart-sticky-info-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 20 20" fill="none">
        <g clip-path="url(#clip0_9858_21616)">
          <path d="M15.4419 0.889418L13.5997 6.33855C13.484 6.41407 13.4013 6.53164 13.3644 6.66424L6.67141 16.5473C6.53653 17.0507 6.83605 17.5695 7.33944 17.7043L15.4143 19.868C15.9177 20.0029 16.4365 19.7034 16.5714 19.2L19.7246 7.42676C19.7606 7.29252 19.7461 7.15031 19.6837 7.02706L16.8058 1.25628C16.5544 0.748981 15.9142 0.577437 15.4419 0.889418ZM15.6057 6.29818C15.0279 6.63173 14.2896 6.4339 13.9561 5.85618C13.6225 5.27846 13.8204 4.54016 14.3981 4.20661C14.9758 3.87307 15.1083 4.21272 15.4419 4.79044C15.7754 5.36816 16.1834 5.96463 15.6057 6.29818Z" fill="#FDB44D"/>
          <mask id="mask0_9858_21616" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="6" y="0" width="14" height="20">
            <path d="M15.4419 0.888441L10.0599 4.4474C9.94425 4.52292 9.86156 4.64049 9.82465 4.77309L6.67141 16.5463C6.53653 17.0497 6.83605 17.5685 7.33944 17.7034L15.4143 19.867C15.9177 20.0019 16.4365 19.7024 16.5714 19.199L19.7246 7.42578C19.7606 7.29155 19.7461 7.14933 19.6837 7.02608L16.8058 1.2553C16.5544 0.748004 15.9142 0.57646 15.4419 0.888441ZM15.6057 6.2972C15.0279 6.63075 14.2896 6.43292 13.9561 5.8552C13.6225 5.27749 13.8204 4.53918 14.3981 4.20563C14.9758 3.87209 15.7141 4.06992 16.0477 4.64763C16.3812 5.22535 16.1834 5.96366 15.6057 6.2972Z" fill="#FDB44D"/>
          </mask>
          <g mask="url(#mask0_9858_21616)">
            <path d="M7.00894 14.5512L12.9304 6.15283L5.34473 13.3515L5.46083 14.203L7.00894 14.5512Z" fill="#DE870F"/>
          </g>
          <path d="M14.8655 0.0933691L8.48795 1.07233C8.35127 1.09249 8.22695 1.16464 8.13792 1.26961L0.345531 10.6414C0.0122968 11.0421 0.0671227 11.6386 0.467808 11.9718L6.89522 17.3173C7.29591 17.6505 7.89245 17.5957 8.22569 17.195L16.0181 7.82321C16.1069 7.71637 16.1533 7.58116 16.1482 7.44309L15.9506 0.997547C15.9346 0.431589 15.425 0.00778321 14.8655 0.0933691ZM12.7499 5.07391C12.0856 5.13496 11.4979 4.64622 11.4369 3.98193C11.3758 3.31763 11.8646 2.72996 12.5288 2.66891C13.1931 2.60786 13.7808 3.0966 13.8419 3.76089C13.9029 4.42518 13.4142 5.01286 12.7499 5.07391Z" fill="url(#paint0_linear_9858_21616)"/>
          <g filter="url(#filter0_d_9858_21616)">
            <path d="M8.99796 11.264C9.24862 11.4813 9.42921 11.7681 9.5169 12.0881C9.60458 12.408 9.59542 12.7468 9.49057 13.0615C9.38571 13.3763 9.18988 13.6529 8.92784 13.8563C8.66579 14.0598 8.34931 14.1809 8.01839 14.2045C7.68748 14.2281 7.35701 14.153 7.06876 13.9888C6.78052 13.8245 6.54745 13.5785 6.39903 13.2818C6.25061 12.9851 6.19351 12.6511 6.23494 12.3219C6.27637 11.9928 6.41448 11.6833 6.6318 11.4326C7.23826 10.7326 8.29755 10.6572 8.99796 11.264ZM4.87488 9.4401L10.452 9.04283C10.5931 9.03421 10.7321 9.07925 10.8413 9.16892C10.9505 9.25858 11.0217 9.38623 11.0406 9.52623C11.0596 9.66623 11.0249 9.80822 10.9435 9.92368C10.862 10.0391 10.74 10.1195 10.6017 10.1487L10.5323 10.158L4.95512 10.5553C4.8141 10.5639 4.67505 10.5189 4.56587 10.4292C4.45669 10.3396 4.38548 10.2119 4.36653 10.0719C4.34758 9.93192 4.38229 9.78993 4.4637 9.67446C4.54511 9.559 4.66719 9.47861 4.80542 9.44943L4.87488 9.4401ZM8.26596 12.1089C8.15392 12.0118 8.00792 11.9633 7.86005 11.9738C7.71219 11.9844 7.57459 12.0533 7.47753 12.1653C7.38046 12.2774 7.33187 12.4234 7.34245 12.5713C7.35304 12.7191 7.42193 12.8567 7.53397 12.9538C7.64601 13.0509 7.79201 13.0994 7.93988 13.0889C8.08774 13.0783 8.22534 13.0094 8.3224 12.8973C8.41947 12.7853 8.46806 12.6393 8.45748 12.4914C8.44689 12.3436 8.378 12.206 8.26596 12.1089ZM8.60117 5.7435C8.85184 5.96082 9.03243 6.24759 9.12011 6.56754C9.20779 6.8875 9.19863 7.22627 9.09378 7.54101C8.98893 7.85576 8.7931 8.13235 8.53105 8.3358C8.26901 8.53925 7.95252 8.66042 7.62161 8.684C7.29069 8.70758 6.96022 8.6325 6.67198 8.46826C6.38373 8.30402 6.15066 8.05799 6.00225 7.76129C5.85383 7.46459 5.79672 7.13054 5.83816 6.80139C5.87959 6.47223 6.0177 6.16276 6.23502 5.91209C6.84147 5.21211 7.90077 5.13668 8.60117 5.7435ZM7.86918 6.58838C7.81373 6.54029 7.74934 6.50359 7.67971 6.48038C7.61008 6.45717 7.53655 6.4479 7.46334 6.45311C7.31547 6.46362 7.17784 6.53244 7.08071 6.64443C6.98359 6.75642 6.93493 6.9024 6.94544 7.05027C6.95595 7.19813 7.02477 7.33577 7.13676 7.43289C7.2488 7.52996 7.39481 7.57855 7.54267 7.56796C7.69053 7.55738 7.82813 7.48849 7.9252 7.37645C8.02227 7.26441 8.07085 7.1184 8.06027 6.97054C8.04968 6.82268 7.98079 6.68508 7.86875 6.58801L7.86918 6.58838Z" fill="#421F03"/>
          </g>
        </g>
        <defs>
          <filter id="filter0_d_9858_21616" x="4.12165" y="5.1623" width="7.16392" height="9.3546" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
            <feFlood flood-opacity="0" result="BackgroundImageFix"/>
            <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
            <feOffset dy="0.0684789"/>
            <feGaussianBlur stdDeviation="0.119838"/>
            <feComposite in2="hardAlpha" operator="out"/>
            <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
            <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_9858_21616"/>
            <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_9858_21616" result="shape"/>
          </filter>
          <linearGradient id="paint0_linear_9858_21616" x1="14.3829" y1="1.19055" x2="4.04618" y2="14.529" gradientUnits="userSpaceOnUse">
            <stop stop-color="#FCD671"/>
            <stop offset="1" stop-color="#FBBB34"/>
          </linearGradient>
          <clipPath id="clip0_9858_21616">
            <rect width="20" height="20" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </div>
    <div class="cart-drawer-storewide-discount-cart-sticky-info-text">
      Spend
      <span class="cart-drawer-storewide-discount-cart-sticky-current-diff-price"></span>
      more for Save
      <span class="cart-drawer-storewide-discount-cart-sticky-current-discount"></span>
      .
    </div>
    <div class="cart-drawer-storewide-discount-cart-sticky-max-discount-text">
      Youâ€™ve unlocked the top savings:
      <span class="cart-drawer-storewide-discount-cart-sticky-current-discount"></span>! ğŸ‰
    </div>
  </div>
  {% comment %}
    <div
      class="cart-drawer-storewide-discount-cart-sticky-progress-bar"
      id="cart-drawer-storewide-discount-cart-sticky-progress-bar"
      style="--p:50%"
    >
      <div class="cart-drawer-storewide-discount-cart-sticky-progress-track"></div>
    </div>
  {% endcomment %}
</div>
<script>
        {% comment %} // æ ¼å¼åŒ–é‡‘é¢ä¸ºè´§å¸å­—ç¬¦ä¸²
        function formatMoney(cents, format) {
          // å¦‚æœ cents æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå»é™¤å°æ•°ç‚¹
          if (typeof cents === 'string') {
            cents = cents.replace('.', '');
          }
          let value = '';
          // å ä½ç¬¦æ­£åˆ™ï¼Œç”¨äºåŒ¹é…æ ¼å¼å­—ç¬¦ä¸²ä¸­çš„ {{ amount }} ç­‰
          const placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
          // å¦‚æœæœªä¼ å…¥ formatï¼Œåˆ™ä½¿ç”¨ moneyFormat å˜é‡
          const formatString = format || moneyFormat;
  
          // å†…éƒ¨å‡½æ•°ï¼šæ ¹æ®åˆ†éš”ç¬¦å’Œç²¾åº¦æ ¼å¼åŒ–æ•°å­—
          function formatWithDelimiters(number, precision = 2, thousands = ',', decimal = '.') {
            // éæ•°å­—æˆ–ç©ºå€¼æ—¶è¿”å›0
            if (isNaN(number) || number == null) {
              return 0;
            }
            // å°†åˆ†å•ä½è½¬æ¢ä¸ºå…ƒå•ä½ï¼Œå¹¶ä¿ç•™æŒ‡å®šå°æ•°ä½
            number = (number / 100.0).toFixed(precision);
  
            const parts = number.split('.');
            // åƒåˆ†ä½åˆ†éš”
            const dollarsAmount = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, `$1${thousands}`);
            // å°æ•°éƒ¨åˆ†
            const centsAmount = parts[1] ? decimal + parts[1] : '';
  
            return dollarsAmount + centsAmount;
          }
  
          // æ ¹æ®æ ¼å¼å­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦ç±»å‹é€‰æ‹©ä¸åŒçš„æ ¼å¼åŒ–æ–¹å¼
          switch (formatString.match(placeholderRegex)[1]) {
            case 'amount':
              // 2ä½å°æ•°ï¼Œåƒåˆ†ä½é€—å·
              value = formatWithDelimiters(cents, 2);
              break;
            case 'amount_no_decimals':
              // æ— å°æ•°ï¼Œåƒåˆ†ä½é€—å·
              value = formatWithDelimiters(cents, 0);
              break;
            case 'amount_with_comma_separator':
              // 2ä½å°æ•°ï¼Œåƒåˆ†ä½ç‚¹ï¼Œå°æ•°é€—å·
              value = formatWithDelimiters(cents, 2, '.', ',');
              break;
            case 'amount_no_decimals_with_comma_separator':
              // æ— å°æ•°ï¼Œåƒåˆ†ä½ç‚¹
              value = formatWithDelimiters(cents, 0, '.', ',');
              break;
            case 'amount_with_apostrophe_separator':
              // 2ä½å°æ•°ï¼Œåƒåˆ†ä½æ’‡å·
              value = formatWithDelimiters(cents, 2, "'", '.');
              break;
          }
  
          // ç”¨æ ¼å¼åŒ–åçš„é‡‘é¢æ›¿æ¢æ ¼å¼å­—ç¬¦ä¸²ä¸­çš„å ä½ç¬¦
          return formatString.replace(placeholderRegex, value);
        } {% endcomment %}
  
  
  
    (function () {
      let format=theme.settings.money_format;
      const currency_code_enabled = theme.settings.currency_code_enabled
      if(currency_code_enabled){
        format = theme.settings.money_with_currency_format;
      }else{
        format = theme.settings.money_format;
      }
  
      // å¦‚æœ this.format åŒ…å« <span class="money"></span>ï¼Œåˆ™æå– > å’Œ < ä¹‹é—´çš„å†…å®¹ä½œä¸ºæ ¼å¼
      const moneySpanMatch = format.match(
        /<span\s+class=["']money["']>(.*?)<\/span>/i
      );
      if (moneySpanMatch) {
        format = moneySpanMatch[1];
      }    
  
  
      function initProgressBar(all_products) {
          // è·å–è¿›åº¦æ¡å®¹å™¨DOMå…ƒç´ 
     
          {% comment %} const bar = document.getElementById('cart-drawer-storewide-discount-cart-sticky-progress-bar'); {% endcomment %}
         
          // è¿›åº¦æ¡è½¨é“éƒ¨åˆ†ï¼ˆå¯ç”¨äºè¿›åº¦æ§½èƒŒæ™¯çš„è‡ªå®šä¹‰ï¼‰
          {% comment %} const progressTrack = bar.querySelector('.cart-drawer-storewide-discount-cart-sticky-progress-track'); {% endcomment %}
          // è·å¾—æ˜¾ç¤ºâ€œè¿˜å·®å¤šå°‘é’±å¯æ»¡è¶³ä¸‹ä¸€ä¸ªæ»¡å‡â€çš„å…ƒç´ 
          const progressDiffPriceValue = document.querySelector('.cart-drawer-storewide-discount-cart-sticky-current-diff-price');
          // è·å¾—æ˜¾ç¤ºâ€œå½“å‰å¯äº«å—ä¼˜æƒ é‡‘é¢â€çš„å…ƒç´ 
          const progressDiscountValue = document.querySelector('.cart-drawer-storewide-discount-cart-sticky-current-discount');

          // é€‰æ‹©æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ï¼ˆå³ä½¿æœ‰å¤šä¸ªä¸€æ ·çš„classï¼‰
        const progressDiscountValues = document.querySelectorAll('.cart-drawer-storewide-discount-cart-sticky-current-discount');
        const progressInfoText = document.querySelector('.cart-drawer-storewide-discount-cart-sticky-info-text');
        const progressMaxDiscountText = document.querySelector('.cart-drawer-storewide-discount-cart-sticky-max-discount-text');
  
  
          // å½“å‰è´­ç‰©è½¦ä¸­æ‰€æœ‰å•†å“
          {% comment %} let all_products = [
              {% for item in cart.items %}
              {
                  id: {{ item.product_id }},
                  price: {{ item.final_line_price }}
              }{% unless forloop.last %},{% endunless %}
              {% endfor %}
          ]; {% endcomment %}
          console.log('å½“å‰è´­ç‰©è½¦ä¸­æ‰€æœ‰å•†å“==',all_products);
          // å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨äºå­˜å‚¨éœ€è¦æ’é™¤çš„product_id
          let exclude_product_list = [
              {%- if storewide_discount_exclude_product_list != blank -%}
              {%- for product in storewide_discount_exclude_product_list -%}
                  {{- product.id -}}{% unless forloop.last %},{% endunless %}
              {%- endfor -%}
              {%- endif -%}
          ];
          console.log('ä¸å‚ä¸æ»¡å‡å•†å“åˆ—è¡¨==',exclude_product_list);
          {% comment %} æ ¹æ®è¦æ±‚ï¼šå°† all_products ä¸­ id ç­‰äº exclude_product_list çš„å•†å“å»é™¤ï¼Œå‰©ä½™å•†å“ price ç´¯åŠ å¾—åˆ°æ–°çš„æ€»ä»· {% endcomment %}
          // è¿‡æ»¤æ‰ä¸å‚ä¸æ»¡å‡çš„å•†å“
          let filtered_products = (exclude_product_list.length > 0)
            ? all_products.filter(function(item) {
                return !exclude_product_list.includes(item.product_id);
              })
            : all_products;
          // ç´¯åŠ å‰©ä½™å•†å“çš„ä»·æ ¼
          let filtered_total_price = filtered_products.reduce(function(sum, item) {
          return sum + item.final_line_price;
          }, 0);
          console.log('å‚ä¸æ»¡å‡å•†å“==', filtered_products);
          console.log('å‚ä¸æ»¡å‡å•†å“ç´¯è®¡ä»·æ ¼==', filtered_total_price);
  
          // å„æ»¡å‡é˜¶æ®µæ‰€éœ€æ»¡è¶³çš„é‡‘é¢ï¼ˆä»å°åˆ°å¤§ï¼Œé‡‘é¢é€’å¢ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€è¦çµæ´»æ‰©å±•ï¼‰
          {% comment %} let phasedDiscountTotalPrice = [1000, 2000, 3000, 4000, 5000, 6000]; {% endcomment %}
  
          let phasedDiscountTotalPrice = [
          {% if storewide_discount_price_value.total_price_1 %}
              {{ storewide_discount_price_value.total_price_1.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_2 %}
              {{ storewide_discount_price_value.total_price_2.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_3 %}
              {{ storewide_discount_price_value.total_price_3.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_4 %}
              {{ storewide_discount_price_value.total_price_4.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_5 %}
              {{ storewide_discount_price_value.total_price_5.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_6 %}
              {{ storewide_discount_price_value.total_price_6.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_7 %}
              {{ storewide_discount_price_value.total_price_7.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_8 %}
              {{ storewide_discount_price_value.total_price_8.value }},
          {% endif %}
          {% if storewide_discount_price_value.total_price_9 %}
              {{ storewide_discount_price_value.total_price_9.value }}
          {% endif %}
          ];
          console.log('å„æ»¡å‡é˜¶æ®µæ‰€éœ€æ»¡è¶³çš„é‡‘é¢==',phasedDiscountTotalPrice)
          // å¯¹åº”æ¯ä¸€æ¡£æ»¡å‡æ‰€èƒ½è·å¾—çš„ä¼˜æƒ é‡‘é¢
          {% comment %} let phasedDiscountPrices = [100, 200, 300, 400, 500, 600]; {% endcomment %}
          let phasedDiscountPrices = [
          {% if storewide_discount_price_value.discount_1 %}{{ storewide_discount_price_value.discount_1.value }},{% endif %}
          {% if storewide_discount_price_value.discount_2 %}{{ storewide_discount_price_value.discount_2.value }},{% endif %}
          {% if storewide_discount_price_value.discount_3 %}{{ storewide_discount_price_value.discount_3.value }},{% endif %}
          {% if storewide_discount_price_value.discount_4 %}{{ storewide_discount_price_value.discount_4.value }},{% endif %}
          {% if storewide_discount_price_value.discount_5 %}{{ storewide_discount_price_value.discount_5.value }},{% endif %}
          {% if storewide_discount_price_value.discount_6 %}{{ storewide_discount_price_value.discount_6.value }},{% endif %}
          {% if storewide_discount_price_value.discount_7 %}{{ storewide_discount_price_value.discount_7.value }},{% endif %}
          {% if storewide_discount_price_value.discount_8 %}{{ storewide_discount_price_value.discount_8.value }},{% endif %}
          {% if storewide_discount_price_value.discount_9 %}{{ storewide_discount_price_value.discount_9.value }}{% endif %}
          ];
          console.log('å¯¹åº”æ¯ä¸€æ¡£æ»¡å‡æ‰€èƒ½è·å¾—çš„ä¼˜æƒ é‡‘é¢==',phasedDiscountPrices)
          // ç¦»ä¸‹ä¸€ä¸ªæ»¡å‡æ¡£ä½çš„å·®ä»·
          let diffPriceValue = 0;
          // å½“å‰å¯äº«å—çš„æ»¡å‡ä¼˜æƒ é‡‘é¢
          let discountValue = 0;
          // å½“å‰è¿›åº¦ç™¾åˆ†æ¯”
          let percentage = 0;
  
          // è®¡ç®—å½“å‰å¤„äºå“ªä¸ªæ»¡å‡æ¡£ä½
          let currentStage = -1; // -1è¡¨ç¤ºå·²ç»è¶…è¿‡æœ€é«˜æ¡£
          for (let i = 0; i < phasedDiscountTotalPrice.length; i++) {
              // æ‰¾åˆ°ç¬¬ä¸€ä¸ª"ç›®æ ‡é‡‘é¢å¤§äºå•†å“æ€»ä»·"çš„æ¡£ä½
              if (filtered_total_price < phasedDiscountTotalPrice[i]) {
                  currentStage = i;
                  break;
              }
          }
  
          // æ ¹æ®å½“å‰çŠ¶æ€è¿›è¡Œè¿›åº¦/å·®é¢/ä¼˜æƒ å€¼çš„è®¡ç®—å’ŒDOMèµ‹å€¼
          if (currentStage === 0) {
              // å°šæœªåˆ°ç¬¬ä¸€æ¡£æ»¡å‡
              diffPriceValue = phasedDiscountTotalPrice[0] - filtered_total_price;
              discountValue = phasedDiscountPrices[0];
              // ç™¾åˆ†æ¯” = å·²ä»˜æ¬¾é‡‘é¢ / ç¬¬ä¸€æ¡£æ»¡å‡é‡‘é¢
             percentage = Math.max(0, Math.min(100, (filtered_total_price / phasedDiscountTotalPrice[0]) * 100));
          } else if (currentStage === -1) {
              // è¶…è¿‡äº†æœ€é«˜æ¡£æ»¡å‡
              diffPriceValue = 0;
              discountValue = phasedDiscountPrices[phasedDiscountPrices.length - 1];
               percentage = 100; 
          } else {
              // ä½äºä¸­é—´æŸä¸€æ¡£
              diffPriceValue = phasedDiscountTotalPrice[currentStage] - filtered_total_price;
              discountValue = phasedDiscountPrices[currentStage];
              let nextTarget = phasedDiscountTotalPrice[currentStage];
              // è¿›åº¦æ ¹æ® nextTarget è®¡ç®—
               percentage = Math.max(0, Math.min(100, (filtered_total_price / nextTarget) * 100));
              console.log('å·®é¢', diffPriceValue);
          }
  
          // å·®é¢ä¿ç•™ä¸¤ä½å°æ•°ï¼Œæ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
          diffPriceValue = Math.max(0, Math.round(diffPriceValue * 100) / 100);
          progressDiffPriceValue.innerHTML = window.formatMoney(
              diffPriceValue,
              format
          );
  
        // ä¸º progressDiscountValues å¤šä¸ªèµ‹å€¼
        if (progressDiscountValues && progressDiscountValues.length > 0) {
          progressDiscountValues.forEach(function(el) {
            el.innerHTML = window.formatMoney(
              discountValue,
              format
            );
          });
        }
        if(percentage == 100){
            progressInfoText.style.width = '0';
            progressInfoText.style.height = '0';
            progressInfoText.style.visibility = 'hidden';
            progressMaxDiscountText.style.width = '100%';
            progressMaxDiscountText.style.height = 'auto';
            progressMaxDiscountText.style.visibility = 'visible';
        }else{ 
            progressInfoText.style.width = '100%';
            progressInfoText.style.height = 'auto';
            progressInfoText.style.visibility = 'visible';
            progressMaxDiscountText.style.width = '0';
            progressMaxDiscountText.style.height = '0';
            progressMaxDiscountText.style.visibility = 'hidden';
        }
          /**
          * æ›´æ–°è¿›åº¦æ¡åŠ¨ç”»æ ·å¼å’Œè¿›åº¦ä¿¡æ¯
          * @param {number} v - å½“å‰è¿›åº¦ï¼Œå€¼èŒƒå›´ä¸º0~100
          */
          {% comment %} function updateProgressElements(v) {
              // ä¿è¯è¿›åº¦ç™¾åˆ†æ¯”åœ¨0~100ä¹‹é—´
              const p = Math.max(0, Math.min(100, v));
              // è®¾ç½®CSSè‡ªå®šä¹‰å±æ€§æ§åˆ¶è¿›åº¦æ¡
              bar.style.setProperty('--p', p + '%');
          }
          // æ›´æ–°è¿›åº¦æ¡CSS
          updateProgressElements(percentage); {% endcomment %}
      }
      {% comment %} è·å–æœ€æ–°è´­ç‰©è½¦ä¿¡æ¯ {% endcomment %}
      window.updateCartStickyProgressInfo =function () {
        const cartStickyWrapper = document.querySelector('.cart-drawer-storewide-discount-cart-sticky-wrapper');
          fetch(`${window.location.origin}/cart.js`)
              .then(function(response) {
                  return response.json();
              })
              .then(function(cartData) {
                  console.log('Cart data:', cartData);
                  if (cartData.items.length === 0) {
                    if (cartStickyWrapper) {
                       cartStickyWrapper.style.opacity = '0';
                        cartStickyWrapper.style.height = '0';
                        cartStickyWrapper.style.visibility = 'hidden';
                      }

                      return;
                  }
                  if (cartStickyWrapper) {
                     cartStickyWrapper.style.opacity = '1';
                    cartStickyWrapper.style.height = 'auto';
                    cartStickyWrapper.style.visibility = 'visible';
                  }
                  const all_products = cartData.items
                  initProgressBar(all_products);
              
                 
                  
              })
              .catch(function(error) {
                  console.error('è·å–è´­ç‰©è½¦ä¿¡æ¯å¤±è´¥:', error);
              });
      }
      
      window.updateCartStickyProgressInfo()  
  
   
  
  
    })();
</script>

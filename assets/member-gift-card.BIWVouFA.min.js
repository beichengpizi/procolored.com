import { L as a } from "./theme.CHt78ou0.min.js";
import { d as r } from "./ender.NhWCw_5c.min.js";
import { i as d } from "./member-api.DuLO-PVi.min.js";
import { c as n, e as o } from "./utils.DPbg__7F.min.js";

class l extends window.HTMLElement {
  constructor() {
    super();
     this.api ="https://booster.procolored.com"  //正式
    // this.api = "https://test.procolored.com" //测试
    this.lotteryRecordsApi = "/procolored/lotteryRecord/getLotteryRecords";
    this.userInfo = JSON.parse(window.localStorage.getItem("smile_shopify_data")) || {};
    this.loading = new a();
    this.initializeComponent();
    this.bindEvents();
  }

  async initializeComponent() {
    const { config: e, api: i } = await d();
    this.MemberApi = i;
    this.config = e;
    await this.update();
  }

  bindEvents() {
    this.addEventListener("click", e => {
      const i = e.target,
        t = i.dataset.copy;
      t && this.handleCopy(i, t);
    });
  }

  handleCopy(e, i) {
    e.innerHTML = "Copy successfully!";
    e.setAttribute("disabled", !0);
    n(i);
    setTimeout(() => {
      e.removeAttribute("disabled");
      e.innerHTML = "Copy";
    }, 1e3);
  }

  getProductById(e) {
    return this.pointsProducts.find(i => e === i.id);
  }
  // 处理UTC时间为本地时间，兼容iOS，并格式化为"2025/8/14 14:50:50"
  parseUTCToLocal(utcString) {
    if (!utcString) return "";
    // 替换T和Z，兼容iOS
    let iosCompatible = utcString
      .replace(/-/g, "/")
      .replace("T", " ")
      .replace("Z", "");
    // 直接用Date解析
    let date = new Date(iosCompatible + " UTC");
    if (isNaN(date.getTime())) {
      // fallback: 直接用原始字符串
      date = new Date(utcString);
    }
    return date;
  }
  // 格式化时间为"2025/8/14 14:50:50"
  // 补零函数
  padZero(num) {
    return num < 10 ? "0" + num : num;
  }
  formatDateToCustomString(date) {
    if (!date || isNaN(date.getTime())) return "";
    const y = date.getFullYear();
    const m = this.padZero(date.getMonth() + 1);
    const d = this.padZero(date.getDate());
    const hh = this.padZero(date.getHours());
    const mm = this.padZero(date.getMinutes());
    const ss = this.padZero(date.getSeconds());
    // 补零输出
    return `${y}/${m}/${d} ${hh}:${mm}:${ss}`;
  }
  // 转盘 查询个人用户中奖记录
  // 改为异步函数，并返回slideHtml
  async getUserLotteryRecords(id, email) {
    console.log("用户ID:", id);
    console.log("用户邮箱:", email);
    try {
      const response = await fetch(
        `${this.api}${this.lotteryRecordsApi}?customerEmail=${email}&&customerId=${id}`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        }
      );
      if (!response.ok) {
        throw new Error("网络请求失败");
      }
      const data = await response.json();
      console.log("查询个人抽奖记录:", data);
      if (data.code === 200) {
        let result = data.result;
        if (Array.isArray(result) && result.length > 0) {



          // 生成所有slideHtml的数组
          // 将 slideHtmlArr 数组拼接成一个字符串返回
          const slideHtmlArr = result.map((item, idx) => {
            if (item.prizeType === 3) {
              // 变量赋值
              const prizeTitle = item.prizeTitle || "";
              const prizeContent = item.prizeContent || "";
              // const prizeType = item.prizeType || "";
              const discountTitle = item.discountTitle || "";
              const prizeUsageScope = item.prizeUsageScope || "";
              const prizePicPc = item.prizePicPc || "";
              // const expireAtUTC = null || "";  // 测试奖品时间永久有效
              // const expireAtUTC = '2025-08-07T10:28:16Z' || "";  // 测试奖品过期时间
              const expireAtUTC = item.expireAt || "";
              let expireAtDate = '';
              let expireAt = ''
              let isExpired = false;
              if (expireAtUTC !== "") {
                expireAtDate = this.parseUTCToLocal(expireAtUTC);
                expireAt = expireAtDate
                  ? this.formatDateToCustomString(expireAtDate)
                  : "";

                // 获取当前时间
                const now = new Date();
                // 判断是否已过期
                isExpired = expireAtDate && now > expireAtDate;

                console.log("UTC折扣券失效时间expireAtUTC :", expireAtUTC);
                console.log("本地折扣券失效时间expireAt:", expireAt);
                console.log("当前时间:", this.formatDateToCustomString(now));
                console.log("是否已过期:", isExpired);

              }

              // usageStatus的值，若isExpired为false时为item.usageStatus，若为true时为"Expired"，默认值为"Used"
              const usageStatus = isExpired ? "Expired" : (item.usageStatus || "Used");
              const commonClasses = "text-sm m-0";
              const accentClasses =
                usageStatus !== "unused" ? "m-0" : "text-accent m-0";
              const idUsedContainer =
                usageStatus !== "unused"
                  ? "bg-gray-50 border-t-gray-400"
                  : "border-t-accent bg-yellow-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all";

              // 生成DOM结构
              const slideHtml = `
             <div class="bg-gray-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all rounded-lg p-6">
    <div class="flex justify-between">
      <div class="space-y-2">
<h2 class="text-xl font-bold ${accentClasses} ">${discountTitle}</h2>
        <div class="flex items-center">
          <p class="text-sm text-black font-medium m-0 min-w-32">Gift Card Code</p>
          <p class="ml-4 text-sm text-gray-800 m-0 uppercase">${o(
                prizeContent,
                0,
                4
              )}</p>
        </div>
          <div class="flex items-center">
        ${prizeUsageScope !== '' ? `<p class="${commonClasses}">${prizeUsageScope}</p>` : ''}
 
        </div>
        <div class="flex items-center">
         ${expireAt !== '' ? `<p class="${commonClasses}">EXP: ${expireAt}</p>` : `<p class="${commonClasses}">Valid for a long time</p>`}
 
        </div>
        <button class="!mt-12 bg-accent text-white py-2 px-4 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${expireAt !== '' ? "" : "disabled"
                } data-copy="${prizeContent}">
          ${expireAt !== ''
                  ? "Copy Code"
                  : "Expired"
                }
        </button>
      </div>
      <div class="w-12 h-12 bg-green-100 flex items-center justify-center rounded-full">
        <img src="${prizePicPc}" alt="${prizeTitle}" class="lazyload w-full h-full object-cover">
      </div>
    </div>
  </div>



            

            `;
              return slideHtml;
            }
          });
          const slideHtmlStr = slideHtmlArr.join('');

          // console.log("slideHtmlStr==", slideHtmlStr);
          return slideHtmlStr;

        } else {
          console.warn("result 不是数组");
          return '';
        }
      } else {
        console.error("查询抽奖记录失败:", data.msg);
        return '';
      }
    } catch (error) {
      console.error("查询抽奖记录失败:", error);
      return '';
    }
  }
  async update() {
    this.loading.show({
      message: "Please wait...",
      spinnerColor: "text-accent"
    });
    try {
      const { reward_fulfillments: e } = await this.MemberApi.getRewardFulfillments(),
        { customer: i } = await this.MemberApi.getCustomesInfo();
      this.customer = i;
      this.customerId = this.userInfo.customer.id;
      this.email = this.userInfo.customer.email;
      console.log("this.customerId===", this.customerId);
      if (this.customerId) {
        this.lotteryRecords = await this.getUserLotteryRecords(this.customerId, this.email);
        console.log("this.lotteryRecords===", this.lotteryRecords);
      }
      this.rewardFulfillments = e.filter(
        t => t.name && t.name.toLowerCase().includes("gift card")
      );
      console.log("this.rewardFulfillments===", this.rewardFulfillments);
      this.render(this.rewardFulfillments);
    } catch (e) {
      console.error("Failed to load points products:", e);
    } finally {
      this.loading.hide();
    }
  }

  render(e) {
    if ((!e || e.length === 0) && (this.lotteryRecords == '')) {
      this.innerHTML = "<div>No Gift Card available for redemption.</div>";
      return;
    }
    const i = e
      .map(
        t => `
 <div class="bg-gray-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all rounded-lg p-6">
    <div class="flex justify-between">
      <div class="space-y-2">
<h2 class="text-xl font-bold text-accent m-0 ">${t.name}</h2>
        <div class="flex items-center">
          <p class="text-sm text-black font-medium m-0 min-w-32">Gift Card Code</p>
          <p class="ml-4 text-sm text-gray-800 m-0 uppercase">${o(
          t.code,
          0,
          4
        )}</p>
        </div>
                  <div class="flex items-center">
        ${t.usage_instructions !== '' ? `<p class="text-sm m-0">${t.usage_instructions}</p>` : ''}
 
        </div>
        <div class="flex items-center">
          <p class="text-sm text-black font-medium m-0 min-w-32">Expired at</p>
          <p class="ml-4 text-sm text-gray-800 m-0">${this.isExpired(t.created_at, 365)
            ? "Expired"
            : r("mm/dd/YYYY", this.getExpiresDate(t.created_at, 365))
          }</p>
        </div>
        <button class="!mt-12 bg-accent text-white py-2 px-4 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${this.isExpired(t.created_at, 365) ? "disabled" : ""
          } data-copy="${t.code}">
          ${this.isExpired(t.created_at, 365)
            ? "Expired"
            : "Copy Code"
          }
        </button>
      </div>
      <div class="w-12 h-12 bg-green-100 flex items-center justify-center rounded-full">
        <img src="${t.image_url}" alt="${t.name}" class="lazyload w-full h-full object-cover">
      </div>
    </div>
  </div>
`
      )
      .join("");
    // 修复 this.innerHTML is not a function
    this.innerHTML = (this.lotteryRecords || '') + i;
  }


  isExpired(e, i) {
    const t = new Date(),
      s = this.getExpiresDate(e, i);
    return t > s;
  }

  getExpiresDate(e, i) {
    const t = new Date(e);
    t.setDate(t.getDate() + i);
    return t;
  }
}

window.customElements.define("member-gift-card", l);

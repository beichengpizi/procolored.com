import { L as n } from "./theme.CHt78ou0.min.js";
import { i as d } from "./member-api.DuLO-PVi.min.js";
import { e as c } from "./utils.DPbg__7F.min.js";
// const api = "https://booster.procolored.com";
// const lotteryRecordsApi = "/procolored/lotteryRecord/getLotteryRecords";
// const userInfo =
//   JSON.parse(window.localStorage.getItem("smile_shopify_data")) || {};
class l extends window.HTMLElement {
  constructor() {
    super();
         this.api ="https://booster.procolored.com"  //正式
        // this.api = "https://test.procolored.com" //测试
        this.lotteryRecordsApi = "/procolored/lotteryRecord/getLotteryRecords";
        this.userInfo = JSON.parse(window.localStorage.getItem("smile_shopify_data")) || {};
    this.loading = new n();
  }

  connectedCallback() {
    if (!window.Shopify.designMode) {
      this._init();
    }
  }

  async _init() {
    this.loading.show({
      message: "Please wait...",
      spinnerColor: "text-accent",
    });
    console.log("[_init] loading shown");
    const result = await d();
    console.log("[_init] d() result:", result);
    const { config: e, api: s } = await d();
    this.MemberApi = s;
    this.config = e;
    console.log("[_init] this.config:", this.config);
    console.log("[_init] this.MemberApi:", this.MemberApi);
    console.log("初始化结束");
    console.log("开始执行更新this.update()");
    await this.update();
  }

  getProductById(e) {
    return this.pointsProducts.find((s) => e === s.id);
  }
  // 处理UTC时间为本地时间，兼容iOS，并格式化为"2025/8/14 14:50:50"
  parseUTCToLocal(utcString) {
    if (!utcString) return "";
    // 替换T和Z，兼容iOS
    let iosCompatible = utcString
      .replace(/-/g, "/")
      .replace("T", " ")
      .replace("Z", "");
    // 直接用Date解析
    let date = new Date(iosCompatible + " UTC");
    if (isNaN(date.getTime())) {
      // fallback: 直接用原始字符串
      date = new Date(utcString);
    }
    return date;
  }
  // 格式化时间为"2025/8/14 14:50:50"
  // 补零函数
  padZero(num) {
    return num < 10 ? "0" + num : num;
  }
  formatDateToCustomString(date) {
    if (!date || isNaN(date.getTime())) return "";
    const y = date.getFullYear();
    const m = this.padZero(date.getMonth() + 1);
    const d = this.padZero(date.getDate());
    const hh = this.padZero(date.getHours());
    const mm = this.padZero(date.getMinutes());
    const ss = this.padZero(date.getSeconds());
    // 补零输出
    return `${y}/${m}/${d} ${hh}:${mm}:${ss}`;
  }
  // 转盘 查询个人用户中奖记录
  // 改为异步函数，并返回slideHtml
  async getUserLotteryRecords(id,email,origin) {
    console.log("用户ID:", id);
    console.log("用户邮箱:", email);
    try {
      const response = await fetch(
        `${this.api}${this.lotteryRecordsApi}?customerEmail=${email}&customerId=${id}&origin=${origin}`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        }
      );
      if (!response.ok) {
        throw new Error("网络请求失败");
      }
      const data = await response.json();
      console.log("查询个人抽奖记录:", data);
      if (data.code === 200) {
        let result = data.result;
        if (Array.isArray(result) && result.length > 0) {
          // 生成所有slideHtml的数组
          // 将 slideHtmlArr 数组拼接成一个字符串返回
          const slideHtmlArr = result.map((item, idx) => {
            if (item.prizeType !== 3) {
            // 变量赋值
            const prizeTitle = item.prizeTitle || "";
            const prizeContent = item.prizeContent || "";
            // const prizeType = item.prizeType || "";
            const discountTitle = item.discountTitle || "";
           const prizeUsageScope = item.prizeUsageScope || "";
            // const expireAtUTC = null || "";  // 测试奖品时间永久有效
            // const expireAtUTC = '2025-08-07T10:28:16Z' || "";  // 测试奖品过期时间
            const expireAtUTC = item.expireAt || "";
            let expireAtDate ='';
            let expireAt=''
            let isExpired = false;
            if(expireAtUTC !== ""){
              expireAtDate = this.parseUTCToLocal(expireAtUTC);
              expireAt = expireAtDate
                ? this.formatDateToCustomString(expireAtDate)
                : "";

              // 获取当前时间
              const now = new Date();
              // 判断是否已过期
               isExpired = expireAtDate && now > expireAtDate;

              console.log("UTC折扣券失效时间expireAtUTC :", expireAtUTC);
              console.log("本地折扣券失效时间expireAt:", expireAt);
              console.log("当前时间:", this.formatDateToCustomString(now));
              console.log("是否已过期:", isExpired);
              
            }
            
            // usageStatus的值，若isExpired为false时为item.usageStatus，若为true时为"Expired"，默认值为"Used"
            const usageStatus = isExpired ? "Expired" : (item.usageStatus || "Used");
            const commonClasses = "text-sm m-0";
            const accentClasses =
              usageStatus !== "unused" ? "m-0" : "text-accent m-0";
            const idUsedContainer =
              usageStatus !== "unused"
                ? "bg-gray-50 border-t-gray-400"
                : "border-t-accent bg-yellow-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all";

            // 生成DOM结构
            const slideHtml = `
            
              <div class="isolate border border-solid border-gray-50 border-t-8 rounded-lg p-4 ${idUsedContainer}">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <h2 class="text-xl font-bold ${accentClasses} ">${discountTitle}</h2>
                    <p class="${accentClasses}">${prizeTitle}</p>
                  </div>
                  <copy-button>
                    <button class="bg-accent text-white py-1 px-3 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${
                      usageStatus !== "unused" ? `disabled` : ``
                    } data-copy="${prizeContent}">
                    ${usageStatus !== "unused" ? usageStatus : "Copy"}
                    </button>
                  </copy-button>
                </div>
                
                <div class="mb-4">
                  <p class="${commonClasses} text-gray-700 font-semibold">
                    CODE: <span class="text-black uppercase">${
                      usageStatus !== "unused" ? c(prizeContent) : prizeContent
                    }</span>
                  </p>
                </div>
                
                <hr class="border-gray-200 mb-4">
                
                <div class="text-gray-600">
                ${prizeUsageScope !== '' ? `<p class="${commonClasses}">${prizeUsageScope}</p>` : ''}
                ${expireAt !== '' ? `<p class="${commonClasses}">EXP: ${expireAt}</p>` : `<p class="${commonClasses}">Valid for a long time</p>`}
                </div>
              </div>
            `;
            return slideHtml;
          }
          });
          const slideHtmlStr = slideHtmlArr.join('');
          // console.log("slideHtmlStr==", slideHtmlStr);
          return slideHtmlStr;
        } else {
          console.warn("result 不是数组");
          return '';
        }
      } else {
        console.error("查询抽奖记录失败:", data.msg);
        return '';
      }
    } catch (error) {
      console.error("查询抽奖记录失败:", error);
      return '';
    }
  }

  async update() {
    try {
      const { reward_fulfillments: e } =
          await this.MemberApi.getRewardFulfillments(),
        { customer: s } = await this.MemberApi.getCustomesInfo();
      this.customer = s;
      console.log("reward_fulfillments===", e);
      console.log("userInfo===", this.userInfo);
      this.customerId = this.userInfo.customer.id;
      this.email = this.userInfo.customer.email;
      this.origin = "Shopify_US";
      console.log("this.customerId===", this.customerId);
      if (this.customerId) {
        this.lotteryRecords = await this.getUserLotteryRecords(this.customerId, this.email,this.origin);
        console.log("this.lotteryRecords===", this.lotteryRecords);
      }
      this.rewardFulfillments = e
        .filter((o) => !o.name || !o.name.toLowerCase().includes("gift card"))
        .reverse();
      this.render(this.rewardFulfillments);
    } catch (e) {
      console.error("Failed to load points products:", e);
    } finally {
      this.loading.hide();
    }
  }

  render(e) {
    var o;
    if (
      !(this.querySelectorAll("[data-local-coupon]").length > 0) &&
      (!e || e.length === 0)&&(this.lotteryRecords == '')
    ) {
      this.innerHTML = "<div>No products available for redemption.</div>";
      return;
    }
    e.forEach((t) => {
      const a = "text-sm m-0",
        r = t.usage_status !== "unused" ? "m-0" : "text-accent m-0",
        i = `
            <div class="isolate border border-solid border-gray-50 border-t-8 rounded-lg p-4 ${
              t.usage_status !== "unused"
                ? "bg-gray-50 border-t-gray-400"
                : "border-t-accent lg:hover:shadow-lg lg:hover:scale-105 transition-all"
            }">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <h2 class="text-xl font-bold ${r} ">${t.name}</h2>
                  <p class="${r}">${t.reason_text}</p>
                </div>
                <copy-button>
                  <button class="bg-accent text-white py-1 px-3 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${
                    t.usage_status !== "unused" ? "disabled" : ""
                  } data-copy="${t.code}">
                  ${t.usage_status !== "unused" ? t.usage_status : "Copy"}
                  </button>
                </copy-button>
              </div>
              
              <div class="mb-4">
                <p class="${a} text-gray-700 font-semibold">
                  CODE: <span class="text-black uppercase">${
                    t.usage_status !== "unused" ? c(t.code) : t.code
                  }</span>
                </p>
              </div>
              
              <hr class="border-gray-200 mb-4">
              
              <div class="text-gray-600">
                <p class="${a}">${t.usage_instructions}</p>
              </div>
            </div>`;
      this.insertAdjacentHTML("beforeend", i);
    });
    this.insertAdjacentHTML("beforeend", this.lotteryRecords);
    (o = this.querySelectorAll("[data-loading-el]")) == null ||
      o.forEach((t) => t.remove());
  }

  get loadBtn() {
    return this.querySelector("[data-load]");
  }
}

window.customElements.define("member-coupon", l);

import{L as $}from"./theme.b18B71bI.min.js";import{d as C}from"./ender.NhWCw_5c.min.js";import{i as T}from"./member-api.CX93Kqd7.min.js";import{c as E,e as y}from"./utils.DPbg__7F.min.js";class D extends window.HTMLElement{constructor(){super(),this.api="https://booster.procolored.com",this.lotteryRecordsApi="/procolored/shopify/getPersonalAsset",this.userInfo=JSON.parse(window.localStorage.getItem("smile_shopify_data"))||{},this.loading=new $,this.initializeComponent(),this.bindEvents()}async initializeComponent(){const{config:e,api:s}=await T();this.MemberApi=s,this.config=e,await this.update()}bindEvents(){this.addEventListener("click",e=>{const s=e.target,t=s.dataset.copy;t&&this.handleCopy(s,t)})}handleCopy(e,s){e.innerHTML="Copy successfully!",e.setAttribute("disabled",!0),E(s),setTimeout(()=>{e.removeAttribute("disabled"),e.innerHTML="Copy"},1e3)}getProductById(e){return this.pointsProducts.find(s=>e===s.id)}parseUTCToLocal(e){if(!e)return"";const s=e.replace(/-/g,"/").replace("T"," ").replace("Z","");let t=new Date(s+" UTC");return isNaN(t.getTime())&&(t=new Date(e)),t}padZero(e){return e<10?"0"+e:e}formatDateToCustomString(e){if(!e||isNaN(e.getTime()))return"";const s=e.getFullYear(),t=this.padZero(e.getMonth()+1),o=this.padZero(e.getDate()),r=this.padZero(e.getHours()),l=this.padZero(e.getMinutes()),m=this.padZero(e.getSeconds());return`${s}/${t}/${o} ${r}:${l}:${m}`}async getUserLotteryRecords(e,s,t){console.log("用户ID:",e),console.log("用户邮箱:",s);try{const o=await fetch(`${this.api}${this.lotteryRecordsApi}?customerEmail=${s}&customerId=${e}&origin=${t}`,{method:"GET",headers:window.ShopifyData.headers});if(!o.ok)throw new Error("网络请求失败");const r=await o.json();if(console.log("查询个人抽奖记录:",r),r.code===200){const l=r.result;return Array.isArray(l)&&l.length>0?l.map((i,L)=>{if(i.prizeType===3){const x=i.prizeTitle||"",u=i.prizeContent||"",w=i.discountTitle||"",h=i.prizeUsageScope||"",b=i.prizePicPc||"",c=i.expireAt||"";let n="",a="",d=!1;if(c!==""){n=this.parseUTCToLocal(c),a=n?this.formatDateToCustomString(n):"";const f=new Date;d=n&&f>n,console.log("UTC折扣券失效时间expireAtUTC :",c),console.log("本地折扣券失效时间expireAt:",a),console.log("当前时间:",this.formatDateToCustomString(f)),console.log("是否已过期:",d)}const g=d?"Expired":i.usageStatus||"Used",p="text-sm m-0",v=g!=="unused"?"m-0":"text-accent m-0",S=g!=="unused"?"bg-gray-50 border-t-gray-400":"border-t-accent bg-yellow-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all";return`
             <div class="bg-gray-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all rounded-lg p-6">
    <div class="flex justify-between">
      <div class="space-y-2">
<h2 class="text-xl font-bold ${v} ">${w}</h2>
        <div class="flex items-center">
          <p class="text-sm text-black font-medium m-0 min-w-32">Gift Card Code</p>
          <p class="ml-4 text-sm text-gray-800 m-0 uppercase">${y(u,0,4)}</p>
        </div>
          <div class="flex items-center">
        ${h!==""?`<p class="${p}">${h}</p>`:""}
 
        </div>
        <div class="flex items-center">
         ${a!==""?`<p class="${p}">EXP: ${a}</p>`:`<p class="${p}">Valid for a long time</p>`}
 
        </div>
        <button class="!mt-12 bg-accent text-white py-2 px-4 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${a!==""?"":"disabled"} data-copy="${u}">
          ${a!==""?"Copy Code":"Expired"}
        </button>
      </div>
      <div class="w-12 h-12 bg-green-100 flex items-center justify-center rounded-full">
        <img src="${b}" alt="${x}" class="lazyload w-full h-full object-cover">
      </div>
    </div>
  </div>



            

            `}}).join(""):(console.warn("result 不是数组"),"")}else return console.error("查询抽奖记录失败:",r.msg),""}catch(o){return console.error("查询抽奖记录失败:",o),""}}async update(){this.loading.show({message:"Please wait...",spinnerColor:"text-accent"});try{const{reward_fulfillments:e}=await this.MemberApi.getRewardFulfillments(),{customer:s}=await this.MemberApi.getCustomesInfo();this.customer=s,this.customerId=this.userInfo.customer.id,this.email=this.userInfo.customer.email,this.origin="Shopify_US",console.log("this.customerId===",this.customerId),this.customerId&&(this.lotteryRecords=await this.getUserLotteryRecords(this.customerId,this.email,this.origin),console.log("this.lotteryRecords===",this.lotteryRecords)),this.rewardFulfillments=e.filter(t=>t.name&&t.name.toLowerCase().includes("gift card")),this.render(this.rewardFulfillments)}catch(e){console.error("Failed to load points products:",e)}finally{this.loading.hide()}}render(e){if((!e||e.length===0)&&this.lotteryRecords==""){this.innerHTML="<div>No Gift Card available for redemption.</div>";return}const s=e.map(t=>` <div class="bg-gray-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all rounded-lg p-6">
    <div class="flex justify-between">
      <div class="space-y-2">
<h2 class="text-xl font-bold text-accent m-0 ">${t.name}</h2>
        <div class="flex items-center">
          <p class="text-sm text-black font-medium m-0 min-w-32">Gift Card Code</p>
          <p class="ml-4 text-sm text-gray-800 m-0 uppercase">${y(t.code,0,4)}</p>
        </div>
                  <div class="flex items-center">
        ${t.usage_instructions!==""?`<p class="text-sm m-0">${t.usage_instructions}</p>`:""}
 
        </div>
        <div class="flex items-center">
          <p class="text-sm text-black font-medium m-0 min-w-32">Expired at</p>
          <p class="ml-4 text-sm text-gray-800 m-0">${this.isExpired(t.created_at,365)?"Expired":C("mm/dd/YYYY",this.getExpiresDate(t.created_at,365))}</p>
        </div>
        <button class="!mt-12 bg-accent text-white py-2 px-4 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${this.isExpired(t.created_at,365)?"disabled":""} data-copy="${t.code}">
          ${this.isExpired(t.created_at,365)?"Expired":"Copy Code"}
        </button>
      </div>
      <div class="w-12 h-12 bg-green-100 flex items-center justify-center rounded-full">
        <img src="${t.image_url}" alt="${t.name}" class="lazyload w-full h-full object-cover">
      </div>
    </div>
  </div>`).join("");this.innerHTML=(this.lotteryRecords||"")+s}isExpired(e,s){const t=new Date,o=this.getExpiresDate(e,s);return t>o}getExpiresDate(e,s){const t=new Date(e);return t.setDate(t.getDate()+s),t}}window.customElements.define("member-gift-card",D);

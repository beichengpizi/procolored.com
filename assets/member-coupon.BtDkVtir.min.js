import{L as v}from"./theme.b18B71bI.min.js";import{i as x}from"./member-api.CX93Kqd7.min.js";import{e as f}from"./utils.DPbg__7F.min.js";class C extends window.HTMLElement{constructor(){super(),this.loading=new v,this.api="https://booster.procolored.com",this.lotteryRecordsApi="/procolored/shopify/getPersonalAsset",this.userInfo=JSON.parse(window.localStorage.getItem("smile_shopify_data"))||{}}connectedCallback(){window.Shopify.designMode||this._init()}async _init(){this.loading.show({message:"Please wait...",spinnerColor:"text-accent"});const{config:e,api:s}=await x();this.MemberApi=s,this.config=e,console.log("[_init] this.config:",this.config),console.log("[_init] this.MemberApi:",this.MemberApi),console.log("初始化结束"),console.log("开始执行更新this.update()"),await this.update()}getProductById(e){return this.pointsProducts.find(s=>e===s.id)}parseUTCToLocal(e){if(!e)return"";const s=e.replace(/-/g,"/").replace("T"," ").replace("Z","");let o=new Date(s+" UTC");return isNaN(o.getTime())&&(o=new Date(e)),o}padZero(e){return e<10?"0"+e:e}formatDateToCustomString(e){if(!e||isNaN(e.getTime()))return"";const s=e.getFullYear(),o=this.padZero(e.getMonth()+1),t=this.padZero(e.getDate()),r=this.padZero(e.getHours()),a=this.padZero(e.getMinutes()),c=this.padZero(e.getSeconds());return`${s}/${o}/${t} ${r}:${a}:${c}`}async getUserLotteryRecords(e,s,o){console.log("用户ID:",e),console.log("用户邮箱:",s);try{const t=await fetch(`${this.api}${this.lotteryRecordsApi}?customerEmail=${s}&customerId=${e}&origin=${o}`,{method:"GET",headers:window.ShopifyData.headers});if(!t.ok)throw new Error("网络请求失败");const r=await t.json();if(console.log("查询个人抽奖记录:",r),r.code===200){const a=r.result;return Array.isArray(a)&&a.length>0?a.map((i,S)=>{if(i.prizeType!==3){const w=i.prizeTitle||"",p=i.prizeContent||"",$=i.discountTitle||"",m=i.prizeUsageScope||"",h=i.expireAt||"";let l="",d="",g=!1;if(h!==""){l=this.parseUTCToLocal(h),d=l?this.formatDateToCustomString(l):"";const y=new Date;g=l&&y>l,console.log("UTC折扣券失效时间expireAtUTC :",h),console.log("本地折扣券失效时间expireAt:",d),console.log("当前时间:",this.formatDateToCustomString(y)),console.log("是否已过期:",g)}const n=g?"Expired":i.usageStatus||"Used",u="text-sm m-0",b=n!=="unused"?"m-0":"text-accent m-0";return`
            
              <div class="isolate border border-solid border-gray-50 border-t-8 rounded-lg p-4 ${n!=="unused"?"bg-gray-50 border-t-gray-400":"border-t-accent bg-yellow-50 lg:hover:shadow-lg lg:hover:scale-105 transition-all"}">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <h2 class="text-xl font-bold ${b} ">${$}</h2>
                    <p class="${b}">${w}</p>
                  </div>
                  <copy-button>
                    <button class="bg-accent text-white py-1 px-3 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${n!=="unused"?"disabled":""} data-copy="${p}">
                    ${n!=="unused"?n:"Copy"}
                    </button>
                  </copy-button>
                </div>
                
                <div class="mb-4">
                  <p class="${u} text-gray-700 font-semibold">
                    CODE: <span class="text-black uppercase">${n!=="unused"?f(p):p}</span>
                  </p>
                </div>
                
                <hr class="border-gray-200 mb-4">
                
                <div class="text-gray-600">
                ${m!==""?`<p class="${u}">${m}</p>`:""}
                ${d!==""?`<p class="${u}">EXP: ${d}</p>`:`<p class="${u}">Valid for a long time</p>`}
                </div>
              </div>
            `}}).join(""):(console.warn("result 不是数组"),"")}else return console.error("查询抽奖记录失败:",r.msg),""}catch(t){return console.error("查询抽奖记录失败:",t),""}}async update(){try{const{reward_fulfillments:e}=await this.MemberApi.getRewardFulfillments(),{customer:s}=await this.MemberApi.getCustomesInfo();this.customer=s,this.customerId=this.userInfo.customer.id,this.email=this.userInfo.customer.email,this.origin="Shopify_US",console.log("this.customerId===",this.customerId),this.customerId&&(this.lotteryRecords=await this.getUserLotteryRecords(this.customerId,this.email,this.origin),console.log("this.lotteryRecords===",this.lotteryRecords)),this.rewardFulfillments=e.filter(o=>!o.name||!o.name.toLowerCase().includes("gift card")).reverse(),this.render(this.rewardFulfillments)}catch(e){console.error("Failed to load points products:",e)}finally{this.loading.hide()}}render(e){var o;if(!(this.querySelectorAll("[data-local-coupon]").length>0)&&(!e||e.length===0)&&this.lotteryRecords==""){this.innerHTML="<div>No products available for redemption.</div>";return}e.forEach(t=>{const r="text-sm m-0",a=t.usage_status!=="unused"?"m-0":"text-accent m-0";t.usage_status;const c=`
          <div class="isolate border border-solid border-gray-50 border-t-8 rounded-lg p-4 ${t.usage_status!=="unused"?"bg-gray-50 border-t-gray-400":"border-t-accent lg:hover:shadow-lg lg:hover:scale-105 transition-all"}">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <h2 class="text-xl font-bold ${a} ">${t.name}</h2>
<!--                  <p class="${a}">${t.reason_text}</p>-->
                </div>
                <copy-button>
                  <button class="bg-accent text-white py-1 px-3 shadow-sm rounded-full hover:bg-accent-hover disabled:cursor-not-allowed disabled:bg-gray-400 focus:outline-none transition-all" ${t.usage_status!=="unused"?"disabled":""} data-copy="${t.code}">
                  ${t.usage_status!=="unused"?t.usage_status:"Copy"}
                  </button>
                </copy-button>
              </div>
              
              <div class="mb-4">
                <p class="${r} text-gray-700 font-semibold">
                  CODE: <span class="text-black uppercase">${t.usage_status!=="unused"?f(t.code):t.code}</span>
                </p>
              </div>
              
              <hr class="border-gray-200 mb-4">
              
              <div class="text-gray-600">
                <p class="${r}">${t.usage_instructions}</p>
              </div>
            </div>`;this.insertAdjacentHTML("beforeend",c)}),this.insertAdjacentHTML("beforeend",this.lotteryRecords),(o=this.querySelectorAll("[data-loading-el]"))==null||o.forEach(t=>t.remove())}get loadBtn(){return this.querySelector("[data-load]")}}window.customElements.define("member-coupon",C);
